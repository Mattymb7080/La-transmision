<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Transmisi칩n Rota</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuente Inter (para men칰s) y IBM Plex Mono (para el juego) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Definici칩n de variables de color para el tema */
        :root {
            --theme-bg: #000000;
            --theme-text: #00ff41; /* Verde CRT por defecto */
            --theme-text-dim: #008f25;
            --theme-text-bright: #adffc6;
            --theme-glow: 0 0 5px #00ff41, 0 0 10px #00ff41;
            --theme-sfx: #f59e0b; /* Naranja/츼mbar para SFX */
            --theme-scare: #ef4444; /* Rojo para sustos */
            --theme-calm: #0284c7; /* Azul para Calmado */
            --theme-agitated: #f59e0b; /* Naranja para Agitado */
            --theme-hurt: #dc2626; /* Rojo para Herido */
            
            /* Colores de Estado (Nuevos) */
            --state-calm: var(--theme-calm);
            --state-hambre: #f59e0b; 
            --state-ansioso: #d946ef; /* Magenta */
            --state-herido: var(--theme-scare);
            --state-fatigado: #6b7280; /* Gris */
        }

        body {
            background-color: var(--theme-bg);
            color: var(--theme-text);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        #app {
            width: 100%;
            height: 100vh;
            border: 2px solid var(--theme-text-dim);
            box-shadow: 0 0 15px var(--theme-text-dim);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: var(--theme-bg);
            position: relative;
        }
        
        /* --- NUEVO: Estilos de Dispositivo --- */
        
        /* Por defecto (PC) */
        .device-pc #app {
            max-width: 1000px;
            height: 100vh;
            max-height: 900px; /* Limita la altura en pantallas grandes */
        }
        
        /* Celular */
        .device-mobile #app {
            max-width: 100%; /* Ocupa todo el ancho */
            max-height: 100vh; /* Ocupa toda la altura */
            border-radius: 0;
            border: none;
        }
        
        .device-mobile #narrative-log {
            font-size: 0.95rem; /* Fuente ligeramente m치s peque침a pero legible */
            line-height: 1.6;
            padding: 1rem;
        }
        
        .device-mobile #options-container {
            padding: 0 1rem 1rem 1rem;
        }
        
        .device-mobile .option-item {
            font-size: 1.1rem; /* Botones de opci칩n m치s grandes */
            padding: 0.75rem 0.5rem;
            margin-top: 0.75rem;
            border: 1px solid var(--theme-text-dim); /* Bordes visibles para mejor toque */
        }
        
        .device-mobile .btn {
            padding: 1rem; /* Botones de men칰 m치s grandes */
            font-size: 1.1rem;
        }
        
        .device-mobile #game-header,
        .device-mobile #game-footer {
            padding: 0.75rem;
        }
        
        .device-mobile #game-header .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .device-mobile #player-state-button,
        .device-mobile #rulo-hud {
            font-size: 0.8rem;
            padding: 0.5rem;
        }

        .device-mobile .modal {
            width: 95%;
            padding: 1.5rem;
        }
        
        /* --- Fin Estilos de Dispositivo --- */


        /* Estilo de la pantalla del juego (CRT) */
        #game-screen {
            font-family: 'IBM Plex Mono', monospace;
            text-shadow: var(--theme-glow);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Efecto de l칤neas de escaneo (Scanlines) */
        #narrative-container::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 4px, 6px 100%;
            pointer-events: none;
            animation: crt-flicker 0.15s infinite;
        }
        
        /* Fix para tema blanco, reduce el efecto de scanline que oscurece el texto */
        .theme-blanco #narrative-container::before {
             background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.01), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.01));
             background-size: 100% 3px, 4px 100%;
        }
        
        @keyframes crt-flicker {
            0% { opacity: 0.95; }
            50% { opacity: 0.85; }
            100% { opacity: 0.95; }
        }

        #narrative-log {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            font-size: 1.1rem;
            line-height: 1.7;
            white-space: pre-wrap;
            position: relative;
            z-index: 1;
        }

        #options-container {
            padding: 0 2rem 2rem 2rem;
            position: relative;
            z-index: 1;
        }

        .option-item {
            display: block;
            font-size: 1.1rem;
            padding: 0.25rem 0.5rem;
            margin-top: 0.5rem;
            cursor: pointer;
            color: var(--theme-text);
            border: 1px solid transparent;
        }

        .option-item:hover {
            background-color: var(--theme-text-dim);
            color: var(--theme-text-bright);
            box-shadow: var(--theme-glow);
            border-color: var(--theme-text);
        }

        /* Cursor parpadeante */
        #cursor {
            display: inline-block;
            width: 10px;
            height: 1.5rem;
            background-color: var(--theme-text);
            box-shadow: var(--theme-glow);
            animation: blink 1s steps(1) infinite;
            margin-left: 2px;
            position: relative;
            top: 4px;
        }
        
        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Botones est치ndar (Men칰s) */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: #1a1a1a;
            border: 2px solid var(--theme-text-dim);
            color: var(--theme-text);
            font-family: 'Inter', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .btn:hover {
            background-color: var(--theme-text-dim);
            color: var(--theme-text-bright);
            box-shadow: var(--theme-glow);
            border-color: var(--theme-text);
        }
        
        /* Fix para tema blanco */
        .theme-blanco .btn {
            background-color: #e5e5e5;
            border-color: #a1a1aa;
        }
        .theme-blanco .btn:hover {
            background-color: #d4d4d8;
            border-color: var(--theme-text);
        }
        
        .btn-secondary {
            background: none;
            border-color: transparent;
            color: var(--theme-text-dim);
        }
        .btn-secondary:hover {
            background: none;
            border-color: transparent;
            color: var(--theme-text-bright);
            text-decoration: underline;
        }
        
        .theme-blanco .btn-secondary {
            color: var(--theme-text-dim);
        }
        .theme-blanco .btn-secondary:hover {
            color: var(--theme-text-bright);
        }
        
        /* Botones de acci칩n de mochila */
        .btn-action {
            background: var(--theme-text-dim);
            color: var(--theme-text-bright);
            padding: 0.25rem 0.5rem;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--theme-text-dim);
        }
        .btn-action:hover {
            background: var(--theme-text);
            color: var(--theme-bg);
            border-color: var(--theme-text-bright);
        }
        
        .theme-blanco .btn-action {
             background: #d4d4d8;
             color: #18181b;
             border-color: #a1a1aa;
        }
        .theme-blanco .btn-action:hover {
             background: #a1a1aa;
             color: #000000;
        }

        /* Encabezado y pie de p치gina del juego */
        #game-header, #game-footer {
            padding: 1rem;
            background-color: #0a0a0a;
            border-color: var(--theme-text-dim);
            position: relative;
            z-index: 10;
        }
        #game-header { border-bottom: 2px solid; }
        #game-footer { border-top: 2px solid; }
        
        .theme-blanco #game-header, .theme-blanco #game-footer {
            background-color: #e5e5e5;
        }

        .location-btn {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--theme-text-dim);
            background: none;
            border: none;
            padding: 0.5rem;
            margin-right: 1rem;
            cursor: pointer;
        }
        .location-btn.active {
            color: var(--theme-text);
            font-weight: bold;
            text-decoration: underline;
        }
        .location-btn:not(.active):hover {
            color: var(--theme-text-bright);
        }
        .location-btn.locked {
            color: #444;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .theme-blanco .location-btn.locked {
            color: #a1a1aa;
        }

        /* --- STATIC --- y SFX */
        .static-line {
            display: block;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            letter-spacing: 0.5em;
            color: var(--theme-text-bright);
            animation: pulse 1s infinite;
            margin: 1rem 0;
        }

        .sfx-text {
            display: block;
            text-align: center;
            font-size: 1rem;
            font-style: italic;
            color: var(--theme-sfx);
            margin: 0.5rem 0;
        }
        
        /* !!! SUSTO !!! */
        .scare-text {
            display: block;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--theme-scare);
            text-shadow: 0 0 10px var(--theme-scare);
            padding: 1rem;
            border: 3px dashed var(--theme-scare);
            margin: 1rem 0;
            animation: text-flicker 0.5s infinite;
        }
        
        .theme-blanco .scare-text {
            text-shadow: none;
        }

        @keyframes text-flicker {
            0% { opacity: 1; }
            40% { opacity: 0.8; }
            50% { opacity: 1; }
            60% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Animaci칩n de "shake" */
        .shake {
            animation: shake 0.3s 1;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: (-8px); }
            80% { transform: translateX(8px); }
        }

        /* Medidor de Ruido */
        #noise-bar-container {
            width: 100%;
            background-color: #222;
            border: 1px solid var(--theme-text-dim);
            border-radius: 4px;
            overflow: hidden;
            height: 1.5rem;
            cursor: pointer;
        }
        #noise-bar {
            height: 100%;
            background-color: var(--theme-calm);
            width: 0%;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
        
        .theme-blanco #noise-bar-container {
            background-color: #d4d4d8;
        }
        
        /* Estados del Jugador (Bot칩n) */
        #player-state-button {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        #player-state-button:hover {
            border-color: var(--theme-text-dim);
            background-color: #1a1a1a;
        }
        
        .theme-blanco #player-state-button:hover {
            background-color: #d4d4d8;
        }
        
        /* Colores de Vida/Estado */
        .life-ok { color: var(--state-calm); }
        .life-low { color: var(--state-hambre); }
        .life-danger { color: var(--state-herido); }
        .life-anxious { color: var(--state-ansioso); }
        
        
        /* Modales (Mochila, Stats) */
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--theme-text);
            box-shadow: var(--theme-glow);
            border-radius: 8px;
            z-index: 100;
            padding: 2rem;
            color: var(--theme-text);
            font-family: 'IBM Plex Mono', monospace;
        }
        
        .theme-blanco .modal {
            background-color: rgba(244, 244, 245, 0.98);
            border-color: var(--theme-text);
        }
        
        .backpack-item .rarity-c { color: var(--theme-text-bright); }
        .backpack-item .rarity-r { color: var(--theme-sfx); }
        .backpack-item .rarity-l { color: var(--theme-scare); }
        
        .backpack-item-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        /* Lista de Estad칤sticas */
        .stats-list {
            list-style: none;
            padding: 0;
            margin-bottom: 1.5rem;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dashed var(--theme-text-dim);
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-bar {
            width: 100px;
            height: 1rem;
            background-color: #222;
            border: 1px solid var(--theme-text-dim);
            border-radius: 2px;
            overflow: hidden;
        }
        .stat-bar-inner {
            height: 100%;
            background-color: var(--theme-text);
            transition: width 0.3s ease;
        }
        
        .theme-blanco .stat-bar {
            background-color: #d4d4d8;
        }

        /* Icono de Guardado */
        #save-icon {
            position: absolute;
            top: 6rem;
            right: 2rem;
            font-size: 2rem;
            color: var(--theme-text-bright);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 200;
            text-shadow: var(--theme-glow);
        }
        
        /* Bot칩n de Reacci칩n Din치mico */
        #reaction-btn {
            position: absolute;
            z-index: 50;
            background-color: var(--theme-scare);
            border: 4px dashed #fff;
            color: #fff;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: bold;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 20px var(--theme-scare), 0 0 30px var(--theme-scare);
            display: none; 
            align-items: center;
            justify-content: center;
            transition: width 0.1s linear, height 0.1s linear, top 0.1s linear, left 0.1s linear;
            animation: pulse-red 0.6s infinite;
        }
        
        .theme-blanco #reaction-btn {
            color: #000;
            border-color: #000;
        }
        
        @keyframes pulse-red {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 20px var(--theme-scare), 0 0 30px var(--theme-scare);
            }
            50% { 
                transform: scale(1.15); 
                box-shadow: 0 0 30px #ff8080, 0 0 45px #ff8080; /* M치s grande y brillante */
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 20px var(--theme-scare), 0 0 30px var(--theme-scare);
            }
        }
        
        /* HUD de Rulo */
        #rulo-hud {
            font-size: 0.9rem;
            margin-left: 1rem;
            border: 1px solid var(--theme-text-dim);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
        #rulo-hud:hover {
            border-color: var(--theme-text-dim);
            background-color: #1a1a1a;
        }
        
        .theme-blanco #rulo-hud:hover {
            background-color: #d4d4d8;
        }
        
        /* Select de Tema */
        #theme-select {
            background-color: #1a1a1a;
            border: 2px solid var(--theme-text-dim);
            color: var(--theme-text);
            font-family: 'Inter', sans-serif;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-bottom: 2rem;
            width: 256px; /* w-64 */
            text-transform: uppercase;
        }
        #theme-select option {
            font-weight: bold;
        }
        
        .theme-blanco #theme-select {
            background-color: #e5e5e5;
            border-color: #a1a1aa;
        }
        
        /* --- NUEVO: Overlay de Selecci칩n de Dispositivo --- */
        #device-select-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-blanco #device-select-overlay {
             background-color: rgba(244, 244, 245, 0.9);
        }
        
        #device-select-box {
            background-color: #0a0a0a;
            border: 2px solid var(--theme-text-dim);
            padding: 2rem 4rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--theme-glow);
        }
        
        .theme-blanco #device-select-box {
             background-color: #e5e5e5;
             border-color: var(--theme-text);
        }
        
        .device-btn {
            padding: 1rem 1.5rem; /* Ajustado */
            font-size: 1.8rem; /* Aumentado para el emoji */
            margin: 0 1rem;
            /* Efecto de hover mejorado */
            transition: all 0.3s ease;
        }
        .device-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--theme-glow);
        }
        
    </style>
</head>
<body class="device-pc"> <!-- Inicia como PC por defecto, JS lo cambiar치 -->

    <div id="app">
    
        <!-- NUEVO: Overlay de Selecci칩n de Dispositivo -->
        <!-- Se mantiene la clase 'hidden' inicial, ya que la funci칩n init la mostrar치 o no seg칰n el guardado. -->
        <div id="device-select-overlay" class="hidden">
            <div id="device-select-box">
                <h2 class="text-2xl font-bold mb-6">Selecciona tu dispositivo</h2>
                <div class="flex">
                    <!-- Iconos a침adidos -->
                    <button id="device-btn-mobile" class="btn device-btn">游님</button>
                    <button id="device-btn-pc" class="btn device-btn">游눹</button>
                </div>
            </div>
        </div>

        <!-- Pantalla: Men칰 Principal -->
        <div id="main-menu" class="hidden flex-col items-center justify-center h-full p-8">
            <h1 class="text-6xl font-bold font-mono text-center mb-12" style="color: var(--theme-text); text-shadow: var(--theme-glow);">LA TRANSMISI칍N</h1>
            
            <button id="play-btn" class="btn text-2xl mb-6 w-64">Jugar</button>
            <button id="settings-btn" class="btn text-xl w-64 mb-4">Ajustes</button>
            <button id="load-checkpoint-btn" class="btn btn-secondary text-lg w-64">Repetir desde guardado</button>
        </div>

        <!-- Pantalla: Opciones -->
        <!-- MODIFICADO: Eliminado justify-center, a침adido padding, a침adido bot칩n de volver al final con mt-auto -->
        <div id="settings-screen" class="hidden flex-col items-center h-full p-8">
            <h2 class="text-3xl font-bold mb-8" style="color: var(--theme-text);">AJUSTES</h2>
            
            <select id="theme-select">
                <option value="green">Verde CRT</option>
                <option value="amber">츼mbar</option>
                <option value="blue">Azul</option>
                <option value="blanco">Blanco</option>
                <option value="negro">Negro</option>
            </select>
            
            <!-- NUEVO: Bot칩n para cambiar dispositivo -->
            <button id="change-device-btn" class="btn text-xl w-64 mt-6">Cambiar Dispositivo</button>
            
            <button id="back-to-menu-btn" class="btn text-xl w-64 mt-auto">Volver</button>
        </div>

        <!-- Pantalla: Juego -->
        <div id="game-screen" class="hidden h-full">
            
            <!-- Encabezado del juego -->
            <div id="game-header" class="flex justify-between items-center">
                <button id="game-back-to-menu-btn" class="btn text-sm py-2 px-4">MEN칔</button>
                <div class="flex items-center space-x-4">
                    <button id="backpack-btn" class="btn text-sm py-2 px-4 hidden">MOCHILA [M]</button>
                    <!-- NUEVO: Bot칩n de estado clicable -->
                    <div id="player-state-button" class="text-sm">
                        ESTADO: <span id="player-state" class="font-bold life-ok">CALMADO</span>
                    </div>
                    <!-- HUD de Rulo (clicable) -->
                    <div id="rulo-hud" class="hidden">
                        RULO: <span id="rulo-state" class="font-bold life-ok">OK</span>
                    </div>
                </div>
            </div>

            <!-- Contenedor de la narrativa -->
            <!-- MODIFICADO: A침adido handleNarrativeClick y nueva estructura de layout -->
            <div id="narrative-container" class="flex-grow flex flex-row relative" onclick="handleNarrativeClick()">
                
                <!-- Columna Izquierda (Principal) -->
                <div id="main-column" class="flex-grow flex flex-col">
                    <div id="narrative-log">
                        <!-- El texto del juego aparece aqu칤 -->
                    </div>
                    
                    <div id="options-container">
                        <!-- Las opciones [ ] aparecen aqu칤 -->
                    </div>
                </div>

                <!-- Columna Derecha (Notificaciones) -->
                <div id="notification-column" class="w-1/3 max-w-sm border-l-2 border-gray-800 flex flex-col hidden">
                    <div id="monster-chance-container" class="p-2 border-b-2 border-gray-800 text-center hidden">
                        <span class="text-red-500 font-bold text-lg" id="monster-chance-percentage"></span>
                    </div>
                    <div id="notification-log" class="flex-grow p-2 overflow-y-auto">
                        <!-- Notificaciones de monstruos y eventos aqu칤 -->
                    </div>
                </div>
            </div>

            <!-- Pie de p치gina (Ruido y Ubicaciones) -->
            <div id="game-footer" class="space-y-4">
                <div class="flex items-center space-x-3">
                    <span class="font-bold">RUIDO:</span>
                    <div id="noise-bar-container" class="flex-grow" title="Intentar reducir ruido...">
                        <div id="noise-bar"></div>
                    </div>
                    <span id="noise-value" class="font-bold w-12 text-right">0</span>
                    <span id="noise-text" class="w-20 text-left" style="color: var(--theme-calm);">Tranquilo</span>
                </div>
                <div class="flex items-center">
                    <span class="font-bold mr-4">UBICACI칍N:</span>
                    <div id="location-menu" class="inline-block">
                        <!-- Botones de ubicaci칩n aqu칤 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Mochila (Inventario) -->
        <div id="backpack-modal" class="modal hidden">
            <h2 class="text-2xl font-bold mb-6">[ MOCHILA ]</h2>
            <div id="backpack-list" class="space-y-3 mb-6">
                <!-- Items del inventario aqu칤 -->
                <div class="backpack-item">Cargando...</div>
            </div>
            <button id="close-backpack-btn" class="btn w-full">Cerrar mochila</button>
        </div>
        
        <!-- NUEVO: Modal de Estad칤sticas del Jugador -->
        <div id="player-stats-modal" class="modal hidden">
            <h2 class="text-2xl font-bold mb-6">[ ESTADO DEL JUGADOR ]</h2>
            <ul id="player-stats-list" class="stats-list">
                <!-- Stats se llenan din치micamente -->
            </ul>
            <button id="close-player-stats-btn" class="btn w-full">Cerrar</button>
        </div>
        
        <!-- NUEVO: Modal de Estad칤sticas de Rulo -->
        <div id="rulo-stats-modal" class="modal hidden">
            <h2 class="text-2xl font-bold mb-6">[ ESTADO DE RULO ]</h2>
            <ul id="rulo-stats-list" class="stats-list">
                <!-- Stats se llenan din치micamente -->
            </ul>
            <button id="close-rulo-stats-btn" class="btn w-full">Cerrar</button>
        </div>
        
        <!-- Icono de guardado -->
        <div id="save-icon">游</div>
        
        <!-- Bot칩n de Reacci칩n Din치mico -->
        <button id="reaction-btn">
            <!-- El temporizador puede ir aqu칤 -->
        </button>

    </div>

    <script>
        // --- CONSTANTES Y UTILIDADES ---
        
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Claves de LocalStorage
        const SAVE_KEY_CURRENT = 'transmision_current';
        const SAVE_KEY_CHECKPOINT = 'transmision_checkpoint';
        const SAVE_KEY_DEVICE = 'transmision_device'; // Para guardar la elecci칩n del dispositivo

        // Pantallas
        const mainMenu = $('#main-menu');
        const settingsScreen = $('#settings-screen');
        const gameScreen = $('#game-screen');
        const deviceSelectOverlay = $('#device-select-overlay');
        
        // Elementos del juego
        const narrativeLog = $('#narrative-log');
        const narrativeContainer = $('#narrative-container');
        const optionsContainer = $('#options-container');
        const locationMenu = $('#location-menu');
        const appContainer = $('#app');
        const playerStateButton = $('#player-state-button'); // Bot칩n clicable
        const playerStateUI = $('#player-state'); // El span de texto
        const ruloHud = $('#rulo-hud');
        const ruloStateUI = $('#rulo-state');
        const noiseBar = $('#noise-bar');
        const noiseValueUI = $('#noise-value');
        const noiseTextUI = $('#noise-text');
        const backpackModal = $('#backpack-modal');
        const backpackList = $('#backpack-list');
        const saveIcon = $('#save-icon');
        const reactionBtn = $('#reaction-btn');
        
        // Modales
        const playerStatsModal = $('#player-stats-modal');
        const playerStatsList = $('#player-stats-list');
        const ruloStatsModal = $('#rulo-stats-modal');
        const ruloStatsList = $('#rulo-stats-list');

        // Estado del juego
        let gameState = {};
        let gameLoopInterval = null;

        // Estado de la escritura (Tipeo)
        let isTyping = false;
        let charTimeout = null;
        let sentenceTimeout = null;
        let currentSentences = [];
        let currentSentenceIndex = 0;
        let currentOnCompleteCallback = null;
        let clearLogOnType = false;
        
        // Estado del Bot칩n de Reacci칩n
        let reactionTimeout = null;
        let reactionTimerInterval = null;
        let reactionWindowMs = 0;
        let reactionStartTime = 0;
        
        // Par치metros del Juego
        const NOISE_DECAY_PER_SECOND = 1; // Reducido para que el puzzle sea m치s 칰til
        const RULO_ALERT_COOLDOWN = 30; // 30 segundos
        const RULO_ALERT_BASE_PROB = 0.2; // 20% base
        const RULO_ALERT_SKILL_FACTOR = 0.6;
        
        // L칤mite de B칰squedas (por ID de sala)
        const SEARCH_LIMITS = {
            'sala_vigilancia': 6,
            'pasillo_este_hub': 8,
            'almacen': 8,
            'oficina_seguridad': 4
        };

        // Definici칩n de temas de color
        // MODIFICADO: A침adidos colores de estado a cada tema
        const themes = {
            green: { 
                name: 'theme-green',
                bg: '#000000', text: '#00ff41', dim: '#008f25', bright: '#adffc6', glow: '0 0 5px #00ff41, 0 0 10px #00ff41',
                sfx: '#f59e0b', scare: '#ef4444', calm: '#0284c7', agitated: '#f59e0b', hurt: '#dc2626' 
            },
            amber: { 
                name: 'theme-amber',
                bg: '#0a0a0a', text: '#f59e0b', dim: '#b45309', bright: '#fcd34d', glow: '0 0 5px #f59e0b, 0 0 10px #f59e0b',
                sfx: '#fde047', scare: '#ef4444', calm: '#38bdf8', agitated: '#f59e0b', hurt: '#dc2626'
            },
            blue: { 
                name: 'theme-blue',
                bg: '#030712', text: '#38bdf8', dim: '#0369a1', bright: '#bfdbfe', glow: '0 0 5px #38bdf8, 0 0 10px #38bdf8',
                sfx: '#f59e0b', scare: '#ef4444', calm: '#38bdf8', agitated: '#f59e0b', hurt: '#dc2626'
            },
            blanco: { 
                name: 'theme-blanco',
                bg: '#f4f4f5', text: '#18181b', dim: '#71717a', bright: '#000000', glow: 'none',
                sfx: '#b45309', scare: '#ef4444', calm: '#0284c7', agitated: '#b45309', hurt: '#dc2626' 
            },
            negro: { 
                name: 'theme-negro',
                bg: '#000000', text: '#ffffff', dim: '#a1a1aa', bright: '#ffffff', glow: '0 0 5px #ffffff',
                sfx: '#f59e0b', scare: '#ef4444', calm: '#38bdf8', agitated: '#f59e0b', hurt: '#dc2626' 
            }
        };
        
        // --- GESTI칍N DE ESTADOS (Porcentajes) ---
        
        /**
         * Modifica una estad칤stica del jugador.
         * @param {string} stat - 'vida', 'ansiedad', 'hambre', 'agua'
         * @param {number} amount - El valor a sumar (puede ser negativo)
         */
        function updatePlayerStat(stat, amount) {
            if (!gameState.playerStats || gameState.playerStats[stat] === undefined) return;
            
            let currentValue = gameState.playerStats[stat];
            let newValue = currentValue + amount;
            
            // L칩gica de Hambre/Agua (suben lento, bajan con items)
            if (stat === 'hambre' || stat === 'agua') {
                newValue = Math.max(0, Math.min(100, newValue));
            }
            // L칩gica de Ansiedad (sube con sustos, baja con items o calma)
            else if (stat === 'ansiedad') {
                newValue = Math.max(0, Math.min(100, newValue));
            }
            // L칩gica de Vida (baja con da침o, sube con items)
            else if (stat === 'vida') {
                newValue = Math.max(0, Math.min(100, newValue));
            }
            
            gameState.playerStats[stat] = newValue;
            renderAllUI();
        }

        /**
         * Modifica la vida de Rulo.
         * @param {number} amount - El valor a sumar (puede ser negativo)
         */
        function updateRuloHP(amount) {
            let newValue = gameState.ruloHP + amount;
            gameState.ruloHP = Math.max(0, Math.min(100, newValue));
            
            // L칩gica de Muerte de Rulo (placeholder)
            if (gameState.ruloHP <= 0 && gameState.flags.rulo_joins) {
                // ... (l칩gica de muerte)
            }
            renderAllUI();
        }

        /**
         * Obtiene un resumen de texto del peor estado del jugador.
         * @returns {string} - "CALMADO", "ANSIOSO", "HAMBRIENTO", "HERIDO"
         */
        function getPlayerStateSummary() {
            const stats = gameState.playerStats;
            if (!stats) return "CALMADO"; // Guard contra estado no inicializado
            
            if (stats.vida <= 40) return "HERIDO";
            if (stats.vida <= 70) return "DA칌ADO";
            if (stats.ansiedad >= 70) return "AGITADO";
            if (stats.ansiedad >= 40) return "ANSIOSO";
            if (stats.hambre >= 60 || stats.agua >= 60) return "FATIGADO";
            
            return "CALMADO";
        }
        
        /**
         * Obtiene la clase CSS para el peor estado del jugador.
         * @returns {string} - "life-ok", "life-anxious", "life-low", "life-danger"
         */
        function getPlayerStateClass() {
            const stats = gameState.playerStats;
            if (!stats) return "life-ok"; // Guard contra estado no inicializado
            
            if (stats.vida <= 40) return "life-danger"; // Rojo
            if (stats.vida <= 70) return "life-low"; // Naranja
            if (stats.ansiedad >= 70) return "life-danger"; // Rojo
            if (stats.ansiedad >= 40) return "life-anxious"; // Magenta
            if (stats.hambre >= 60 || stats.agua >= 60) return "life-low"; // Naranja
            
            return "life-ok"; // Azul
        }
        
        // --- SISTEMA DE GUARDADO Y CARGA ---

        function saveGameState() {
            try {
                localStorage.setItem(SAVE_KEY_CURRENT, JSON.stringify(gameState));
            } catch (e) {
                console.error("Error guardando el estado del juego:", e);
            }
        }

        function loadGameState() {
            try {
                const savedData = localStorage.getItem(SAVE_KEY_CURRENT);
                if (savedData) {
                    gameState = JSON.parse(savedData);
                    
                    // --- CORRECCI칍N DE ERROR Y ROBUSTEZ ---
                    // A침ade valores por defecto para propiedades que podr칤an faltar en un guardado antiguo
                    
                    if (!gameState.unlockedLocations) {
                        gameState.unlockedLocations = ['sala_vigilancia'];
                    }
                    if (!gameState.playerStats) {
                        gameState.playerStats = { vida: 100, ansiedad: 0, hambre: 0, agua: 0 };
                    }
                    if (gameState.ruloHP === undefined) {
                        gameState.ruloHP = 100;
                    }
                    if (!gameState.roomNoise) {
                        // Transfiere el ruido global antiguo (si existe) al nuevo sistema por salas
                        const oldNoise = gameState.noise || 0;
                        gameState.roomNoise = {
                            'start': 0, 'sala_vigilancia': oldNoise, 'pasillo_este_hub': 0, 'almacen': 0, 
                            'oficina_seguridad': 0, 'sotano': 0, 'panel_pasillo': 0, 'revisar_radio': 0, 
                            'buscar_salida': 0, 'parte1_fin_exito': 0, 'eco_cerca': 0, 
                            'pasillo_este_intro': 0, 'abrir_mochila': 0, 'puzzle_ruido_intro': 0, 
                            'puzzle_fusibles_1': 0, 'ajustes_dispositivo': 0
                        };
                        delete gameState.noise; // Limpia la propiedad antigua
                    }
                    if (!gameState.roomCounters) {
                        gameState.roomCounters = {
                            'sala_vigilancia': 0, 'pasillo_este_hub': 0, 'almacen': 0, 'oficina_seguridad': 0
                        };
                    }
                    // MODIFICADO: Asegurarse de que 'location' exista y no sea 'start'
                    if (!gameState.location || gameState.location === 'start') {
                        gameState.location = 'sala_vigilancia';
                    }
                    if (!gameState.previousLocation) {
                        gameState.previousLocation = 'sala_vigilancia';
                    }
                    // --- Fin de la correcci칩n ---
                    
                    return true;
                }
            } catch (e) {
                console.error("Error cargando el estado del juego:", e);
            }
            return false;
        }

        function saveCheckpoint() {
            try {
                localStorage.setItem(SAVE_KEY_CHECKPOINT, JSON.stringify(gameState));
                localStorage.setItem(SAVE_KEY_CURRENT, JSON.stringify(gameState));
                flashSaveIcon();
            } catch (e) {
                console.error("Error guardando checkpoint:", e);
            }
        }

        function loadCheckpoint() {
            try {
                const savedData = localStorage.getItem(SAVE_KEY_CHECKPOINT);
                if (savedData) {
                    gameState = JSON.parse(savedData);
                    saveGameState();
                    startGameFromMenu(true); // MODIFICADO: Llama a la nueva funci칩n
                } else {
                    console.warn("No hay punto de guardado.");
                }
            } catch (e) {
                console.error("Error cargando checkpoint:", e);
            }
        }
        
        function flashSaveIcon() {
            saveIcon.style.opacity = '1';
            setTimeout(() => {
                saveIcon.style.opacity = '0';
            }, 1500);
        }

        function resetGame() {
            localStorage.removeItem(SAVE_KEY_CURRENT);
            localStorage.removeItem(SAVE_KEY_CHECKPOINT);
            // NOTA: No borramos SAVE_KEY_DEVICE
            
            gameState = {
                location: 'sala_vigilancia', // MODIFICADO: Empezar en la sala
                previousLocation: 'sala_vigilancia', // MODIFICADO
                inventory: {},
                roomNoise: {
                    'start': 0, 'sala_vigilancia': 0, 'pasillo_este_hub': 0, 'almacen': 0, 
                    'oficina_seguridad': 0, 'sotano': 0, 'panel_pasillo': 0, 'revisar_radio': 0, 
                    'buscar_salida': 0, 'parte1_fin_exito': 0, 'eco_cerca': 0, 
                    'pasillo_este_intro': 0, 'abrir_mochila': 0, 'puzzle_ruido_intro': 0, 
                    'puzzle_fusibles_1': 0, 'ajustes_dispositivo': 0
                },
                playerStats: {
                    vida: 100,
                    ansiedad: 0,
                    hambre: 0,
                    agua: 0
                },
                ruloHP: 100,
                flags: {
                    rulo_awake: false,
                    rulo_awake_calm: false,
                    radio_pista: false,
                    panel_abierto: false,
                    rulo_talked: false,
                    rulo_joins: false,
                    backpack_enabled: false
                },
                unlockedLocations: ['sala_vigilancia'],
                monsterPresent: false,
                monsterApproaching: false,
                monsterTime: 0,
                ruloAlertCooldown: 0,
                ruloAlertActive: false,
                ruloAlertSkill: 0.7,
                roomCounters: {
                    'sala_vigilancia': 0,
                    'pasillo_este_hub': 0,
                    'almacen': 0,
                    'oficina_seguridad': 0
                }
            };
            saveGameState(); // Guarda el estado limpio
        }

        // --- NAVEGACI칍N Y MEN칔S ---

        // MODIFICADO: Soluci칩n robusta para ocultar/mostrar pantallas
        function showScreen(screenId) {
            // Ocultar todas las pantallas principales
            mainMenu.style.display = 'none';
            settingsScreen.style.display = 'none';
            gameScreen.style.display = 'none';
            deviceSelectOverlay.style.display = 'none';
            
            const gameMenuBtn = $('#game-back-to-menu-btn');
            
            if (screenId === 'main') {
                mainMenu.style.display = 'flex';
                if (gameMenuBtn) gameMenuBtn.classList.add('hidden');
            }
            if (screenId === 'settings') {
                settingsScreen.style.display = 'flex';
                if (gameMenuBtn) gameMenuBtn.classList.add('hidden');
            }
            if (screenId === 'game') {
                gameScreen.style.display = 'flex';
                if (gameMenuBtn) gameMenuBtn.classList.remove('hidden');
            }
            if (screenId === 'device_select') {
                deviceSelectOverlay.style.display = 'flex';
                if (gameMenuBtn) gameMenuBtn.classList.add('hidden');
            }
        }

        // MODIFICADO: Funci칩n de tema actualizada
        function changeTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            const root = document.documentElement;
            root.style.setProperty('--theme-bg', theme.bg);
            root.style.setProperty('--theme-text', theme.text);
            root.style.setProperty('--theme-text-dim', theme.dim);
            root.style.setProperty('--theme-text-bright', theme.bright);
            root.style.setProperty('--theme-glow', theme.glow);
            
            // Nuevas propiedades de tema
            root.style.setProperty('--theme-sfx', theme.sfx);
            root.style.setProperty('--theme-scare', theme.scare);
            root.style.setProperty('--theme-calm', theme.calm);
            root.style.setProperty('--theme-agitated', theme.agitated);
            root.style.setProperty('--theme-hurt', theme.hurt);
            
            // Quitar clases de tema antiguas del body
            Object.values(themes).forEach(t => {
                document.body.classList.remove(t.name);
            });
            // A침adir clase de tema actual
            document.body.classList.add(theme.name);
            
            // Guardar tema elegido
            localStorage.setItem('transmision_theme', themeName);
        }
        
        // --- L칩gica de Selecci칩n de Dispositivo ---
        function selectDevice(type) {
            const body = document.body;
            body.classList.remove('device-pc', 'device-mobile');
            
            if (type === 'mobile') {
                body.classList.add('device-mobile');
                localStorage.setItem(SAVE_KEY_DEVICE, 'mobile');
                $('#backpack-btn').textContent = 'MOCHILA'; 
            } else {
                body.classList.add('device-pc');
                localStorage.setItem(SAVE_KEY_DEVICE, 'pc');
                $('#backpack-btn').textContent = 'MOCHILA [M]'; 
            }
            
            // Ocultar overlay y mostrar men칰 principal
            // *** SOLUCI칍N ROBUSTA ***
            deviceSelectOverlay.style.display = 'none'; 
            
            // MODIFICADO: Mostrar el men칰 principal, no iniciar el juego
            showScreen('main'); 
        }
        
        // MODIFICADO: Nueva funci칩n de inicio de juego
        function startGameFromMenu(forceReload = false) {
            stopGameLoop();
            let isContinue = $('#play-btn').textContent === 'Continuar';
            
            if (!forceReload && isContinue && loadGameState()) {
                // Estado cargado
            } else {
                // Empezar nueva
                resetGame();
            }
            
            showScreen('game');
            renderAllUI();
            showNode(gameState.location); // Muestra 'sala_vigilancia' (nuevo) o el guardado
            startGameLoop();
        }

        function goToMenu() {
            stopGameLoop();
            saveGameState();
            showScreen('main');
            if (localStorage.getItem(SAVE_KEY_CURRENT)) {
                $('#play-btn').textContent = 'Continuar';
            }
        }
        
        function resumeGame() {
            showNode(gameState.location);
            startGameLoop();
        }

        // --- BUCLE DE JUEGO (RUIDO, APARICI칍N) ---

        function startGameLoop() {
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(() => {
                if (gameState.monsterPresent || gameState.monsterApproaching || !gameState.playerStats) {
                    return; // No hacer nada si hay monstruo o si el estado no est치 listo
                }
                
                // Decaimiento de Ruido (solo en la sala actual)
                const currentRoomNoise = gameState.roomNoise[gameState.location] || 0;
                if (currentRoomNoise > 0) {
                    changeRoomNoise(gameState.location, -NOISE_DECAY_PER_SECOND, true); // true = decay
                }
                
                // Aumento de Hambre/Agua (muy lento)
                updatePlayerStat('hambre', 0.05); // Ajustar este valor
                updatePlayerStat('agua', 0.08); // Ajustar este valor
                
                // Cooldown de Rulo
                if (gameState.ruloAlertCooldown > 0) {
                    gameState.ruloAlertCooldown--;
                }
                
                checkRuloAlert();
                checkMonsterSpawn();
                
                renderNoiseBar();
                renderPlayerState(); // Para que Hambre/Agua actualicen el estado
                
            }, 1000);
        }

        function stopGameLoop() {
            clearInterval(gameLoopInterval);
            gameLoopInterval = null;
        }

        // --- SISTEMA DE ESCRITURA (TIPEO) ---

        function typeText(fullText, clearLog = false, onComplete = () => {}) {
            if (isTyping) {
                finishTyping(true); 
            }
            
            if (clearLog) {
                narrativeLog.innerHTML = '';
            }
            clearLogOnType = clearLog;

            currentSentences = fullText.split('\n').filter(s => s.trim().length > 0);
            currentSentenceIndex = 0;
            currentOnCompleteCallback = onComplete;
            isTyping = true;
            
            typeSentence();
        }

        function typeSentence() {
            if (currentSentenceIndex >= currentSentences.length) {
                finishTyping(false); 
                return;
            }

            const sentence = currentSentences[currentSentenceIndex];
            
            if (currentSentenceIndex === 0 && clearLogOnType) {
                 const prefix = document.createElement('span');
                 prefix.className = 'text-gray-500';
                 prefix.textContent = '> ';
                 narrativeLog.appendChild(prefix);
            }
            
            const textSpan = document.createElement('span');
            narrativeLog.appendChild(textSpan);

            const cursor = document.createElement('span');
            cursor.id = 'cursor';
            narrativeLog.appendChild(cursor);
            
            narrativeLog.scrollTop = narrativeLog.scrollHeight;

            let i = 0;
            function typeChar() {
                if (i < sentence.length) {
                    textSpan.innerHTML += sentence.charAt(i);
                    i++;
                    charTimeout = setTimeout(typeChar, 25);
                } else {
                    cursor.remove();
                    textSpan.innerHTML += '<br>';
                    currentSentenceIndex++;
                    sentenceTimeout = setTimeout(typeSentence, 350);
                }
            }
            typeChar();
        }
        
        function skipTyping() {
            if (!isTyping) return; // MODIFICADO: Solo skipea si est치 tipeando

            clearTimeout(charTimeout);
            clearTimeout(sentenceTimeout);

            const cursor = $('#cursor');
            
            if (cursor) {
                const textSpan = cursor.previousElementSibling;
                if (textSpan && currentSentences[currentSentenceIndex]) { 
                    textSpan.innerHTML = currentSentences[currentSentenceIndex];
                    textSpan.innerHTML += '<br>';
                }
                cursor.remove();
            }
            
            currentSentenceIndex++;
            typeSentence(); // Avanza a la siguiente o finaliza
        }


        function finishTyping(internalSkip = false) {
            isTyping = false;
            clearTimeout(charTimeout);
            clearTimeout(sentenceTimeout);
            $('#cursor')?.remove();

            if (!internalSkip && currentOnCompleteCallback) {
                currentOnCompleteCallback();
            }
            
            currentOnCompleteCallback = null;
            currentSentences = [];
            currentSentenceIndex = 0;
            clearLogOnType = false;
        }

        // --- L칍GICA DE NODOS Y OPCIONES ---

        function showNode(nodeId) {
            // No guardar "nodos de puzzle" como ubicaci칩n anterior
            if (nodeId.startsWith('puzzle_') || nodeId === 'ajustes_dispositivo') {
                // No actualizar previousLocation
            } else {
                gameState.previousLocation = gameState.location;
            }
            gameState.location = nodeId;
            
            const node = GAME_CONTENT[nodeId];
            if (!node) {
                console.error(`Nodo no encontrado: ${nodeId}`);
                return;
            }

            optionsContainer.innerHTML = '';
            
            if (node.onEnter) {
                if (node.onEnter.params) {
                    window[node.onEnter.func](node.onEnter.params);
                } else {
                    window[node.onEnter.func]();
                }
            }
            
            if (node.effect) {
                gameEffects[node.effect.name](node.effect.params);
            }
            
            // Actualizar UI de ruido para la nueva sala
            renderNoiseBar();
            
            typeText(node.text, true, () => {
                renderOptions(node.options);
            });
            
            if (node.isLocationHub) {
                renderLocations();
            }
            
            if (node.isCheckpoint) {
                saveCheckpoint();
            }
        }
        
        function renderOptions(options) {
            optionsContainer.innerHTML = '';
            if (!options || options.length === 0) return;
            
            options.forEach(option => {
                if (option.condition && !window[option.condition.func](option.condition.params)) {
                    return;
                }

                const optEl = document.createElement('a');
                optEl.className = 'option-item';
                
                let optionText = option.text;
                if (option.countsSearch) {
                    const count = gameState.roomCounters[option.countsSearch] || 0;
                    const max = SEARCH_LIMITS[option.countsSearch] || 0;
                    optionText += ` (${count}/${max})`;
                }
                
                optEl.textContent = `[ ${optionText} ]`;
                
                optEl.onclick = () => handleOptionClick(option);
                optionsContainer.appendChild(optEl);
            });
            narrativeLog.scrollTop = narrativeLog.scrollHeight;
        }
        
        function handleOptionClick(option) {
            optionsContainer.innerHTML = '';
            
            if (option.countsSearch) {
                const count = gameState.roomCounters[option.countsSearch] || 0;
                const max = SEARCH_LIMITS[option.countsSearch] || 0;
                
                if (count >= max) {
                    typeText("No queda nada m치s por aqu칤.", true, () => {
                        renderOptions(GAME_CONTENT[gameState.location].options);
                    });
                    return;
                }
                gameState.roomCounters[option.countsSearch]++;
            }
            
            if (option.action) {
                if (option.action.params) {
                    window[option.action.func](option.action.params);
                } else {
                     window[option.action.func]();
                }
            } else if (option.target) {
                showNode(option.target);
            }
        }

        // --- RENDERIZADO DE UI ---
        
        function renderAllUI() {
            renderLocations();
            renderNoiseBar();
            renderPlayerState();
            renderRuloState();
            renderHeaderUI();
        }
        
        function renderHeaderUI() {
            const backpackBtn = $('#backpack-btn');
            if (gameState.flags.backpack_enabled) {
                backpackBtn.classList.remove('hidden');
            } else {
                backpackBtn.classList.add('hidden');
            }
        }

        function renderLocations() {
            locationMenu.innerHTML = '';
            const locations = [
                { id: 'sala_vigilancia', name: 'Sala de Vigilancia' },
                { id: 'pasillo_este_hub', name: 'Pasillo Este' },
                { id: 'almacen', name: 'Almac칠n' },
                { id: 'oficina_seguridad', name: 'Oficina Seguridad' },
                { id: 'sotano', name: 'S칩tano' },
            ];
            
            // CORRECCI칍N DE ERROR: A침adir guardia por si unlockedLocations no existe
            const unlocked = gameState.unlockedLocations || ['sala_vigilancia'];

            locations.forEach(loc => {
                const isLocked = !unlocked.includes(loc.id); // Usar la variable 'unlocked'
                const locBtn = document.createElement('button');
                locBtn.textContent = loc.name;
                
                if (isLocked) {
                    locBtn.className = 'location-btn locked';
                    locBtn.disabled = true;
                } else {
                    locBtn.className = 'location-btn';
                    if (gameState.location === loc.id) {
                        locBtn.classList.add('active');
                    }
                    locBtn.onclick = () => showNode(loc.id);
                }
                locationMenu.appendChild(locBtn);
            });
        }

        function renderNoiseBar() {
            const noise = gameState.roomNoise[gameState.location] || 0; // Lee el ruido de la sala actual
            noiseValueUI.textContent = Math.round(noise);
            noiseBar.style.width = `${noise}%`;
            
            if (noise >= 75) {
                noiseBar.style.backgroundColor = 'var(--theme-scare)';
                noiseTextUI.textContent = 'Peligro';
                noiseTextUI.style.color = 'var(--theme-scare)';
            } else if (noise >= 50) {
                noiseBar.style.backgroundColor = 'var(--theme-agitated)';
                noiseTextUI.textContent = 'Inquieto';
                noiseTextUI.style.color = 'var(--theme-agitated)';
            } else {
                noiseBar.style.backgroundColor = 'var(--theme-calm)';
                noiseTextUI.textContent = 'Tranquilo';
                noiseTextUI.style.color = 'var(--theme-calm)';
            }
        }
        
        function renderPlayerState() {
            const stateText = getPlayerStateSummary();
            const stateClass = getPlayerStateClass();
            
            playerStateUI.textContent = stateText;
            playerStateUI.className = 'font-bold'; // Limpia clases viejas
            playerStateUI.classList.add(stateClass);
        }
        
        function renderRuloState() {
            if (!gameState.flags.rulo_joins) {
                ruloHud.classList.add('hidden');
                return;
            }
            
            ruloHud.classList.remove('hidden');
            const hp = gameState.ruloHP;
            let stateText = "OK";
            let stateClass = "life-ok";
            
            if (hp <= 40) { stateText = "HERIDO"; stateClass = "life-danger"; }
            else if (hp <= 70) { stateText = "DA칌ADO"; stateClass = "life-low"; }
            
            ruloStateUI.textContent = stateText;
            ruloStateUI.className = 'font-bold';
            ruloStateUI.classList.add(stateClass);
        }
        
        // --- Modales de Stats y Mochila ---
        
        function toggleBackpack() {
            if (!gameState.flags.backpack_enabled) return;
            
            if (backpackModal.classList.contains('hidden')) {
                closeAllModals(); // Cierra otros modales primero
                renderBackpack();
                backpackModal.classList.remove('hidden');
            } else {
                closeAllModals(); // Simplemente cierra este
            }
        }
        
        function togglePlayerStats() {
            if (playerStatsModal.classList.contains('hidden')) {
                closeAllModals(); // Cierra otros modales primero
                renderPlayerStatsModal();
                playerStatsModal.classList.remove('hidden');
            } else {
                closeAllModals(); // Simplemente cierra este
            }
        }
        
        function toggleRuloStats() {
            if (!gameState.flags.rulo_joins) return;
            
            if (ruloStatsModal.classList.contains('hidden')) {
                closeAllModals(); // Cierra otros modales primero
                renderRuloStatsModal();
                ruloStatsModal.classList.remove('hidden');
            } else {
                closeAllModals(); // Simplemente cierra este
            }
        }
        
        function closeAllModals() {
            backpackModal.classList.add('hidden');
            playerStatsModal.classList.add('hidden');
            ruloStatsModal.classList.add('hidden');
        }
        
        // --- NUEVA FUNCI칍N: Cierra modales al hacer clic afuera ---
        function handleNarrativeClick() {
            closeAllModals();
            skipTyping(); // Sigue permitiendo skipear el texto
        }
        
        function renderBackpack() {
            backpackList.innerHTML = '';
            const items = Object.values(gameState.inventory);
            
            if (items.length === 0) {
                backpackList.innerHTML = '<div class="backpack-item">Vac칤a...</div>';
                return;
            }
            
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'backpack-item flex justify-between items-center';
                
                let rarityClass = 'rarity-c';
                if (item.rarity === 'R') rarityClass = 'rarity-r';
                if (item.rarity === 'L') rarityClass = 'rarity-l';
                
                const itemInfo = `
                    <span><span class="${rarityClass}">(${item.rarity})</span> ${item.name}</span>
                    <span>x${item.qty}</span>
                `;
                
                const actionsEl = document.createElement('div');
                actionsEl.className = 'backpack-item-actions';
                
                if (item.consumable) {
                    const useBtn = document.createElement('button');
                    useBtn.textContent = 'Usar';
                    useBtn.className = 'btn-action';
                    useBtn.onclick = () => useItem(item.id, 'player');
                    actionsEl.appendChild(useBtn);
                    
                    if (gameState.flags.rulo_joins) {
                        const giveBtn = document.createElement('button');
                        giveBtn.textContent = 'Dar a Rulo';
                        giveBtn.className = 'btn-action';
                        giveBtn.onclick = () => useItem(item.id, 'rulo');
                        actionsEl.appendChild(giveBtn);
                    }
                }
                
                el.innerHTML = itemInfo;
                el.appendChild(actionsEl);
                backpackList.appendChild(el);
            });
        }
        
        function createStatBar(label, value, colorClass) {
            const percent = Math.max(0, Math.min(100, Math.round(value)));
            let color;
            if (colorClass === 'herido') color = 'var(--state-herido)';
            else if (colorClass === 'hambre') color = 'var(--state-hambre)';
            else if (colorClass === 'ansioso') color = 'var(--state-ansioso)';
            else color = 'var(--state-calm)';
            
            return `
                <li class="stat-item">
                    <span style="color: ${color}">${label}: ${percent}%</span>
                    <div class="stat-bar">
                        <div class="stat-bar-inner" style="width: ${percent}%; background-color: ${color};"></div>
                    </div>
                </li>
            `;
        }
        
        function renderPlayerStatsModal() {
            const stats = gameState.playerStats;
            let html = '';
            html += createStatBar('Vida', stats.vida, (stats.vida <= 40 ? 'herido' : (stats.vida <= 70 ? 'hambre' : 'calm')));
            html += createStatBar('Ansiedad', stats.ansiedad, (stats.ansiedad >= 70 ? 'herido' : (stats.ansiedad >= 40 ? 'ansioso' : 'calm')));
            html += createStatBar('Hambre', stats.hambre, (stats.hambre >= 60 ? 'hambre' : 'calm'));
            html += createStatBar('Agua', stats.agua, (stats.agua >= 60 ? 'hambre' : 'calm'));
            
            playerStatsList.innerHTML = html;
        }
        
        function renderRuloStatsModal() {
            const hp = gameState.ruloHP;
            let html = '';
            html += createStatBar('Vida', hp, (hp <= 40 ? 'herido' : (hp <= 70 ? 'hambre' : 'calm')));
            ruloStatsList.innerHTML = html;
        }
        
        function useItem(itemId, target) {
            if (!hasItem(itemId)) return;
            
            const item = gameState.inventory[itemId];
            let feedbackText = "";
            
            switch (itemId) {
                case 'barrita':
                    if (target === 'player') updatePlayerStat('hambre', -40);
                    else updateRuloHP(5); // Curaci칩n menor para Rulo
                    feedbackText = (target === 'player' ? "Comes" : "Rulo come") + " la barrita. El hambre disminuye.";
                    break;
                case 'botella_agua':
                    if (target === 'player') updatePlayerStat('agua', -50);
                    else updateRuloHP(5);
                    feedbackText = (target === 'player' ? "Bebes" : "Rulo bebe") + " agua. Te sientes un poco mejor.";
                    break;
                case 'vendaje':
                    let targetHP = (target === 'player') ? gameState.playerStats.vida : gameState.ruloHP;
                    if (targetHP < 100) {
                        if (target === 'player') updatePlayerStat('vida', 30);
                        else updateRuloHP(30);
                        feedbackText = (target === 'player' ? "Aplicas" : "Rulo aplica") + " el vendaje. La herida cierra un poco.";
                    } else {
                        feedbackText = (target === 'player' ? "No est치s" : "Rulo no est치") + " herido.";
                        return; // No consumir si no est치 herido
                    }
                    break;
                default:
                    return; 
            }
            
            removeItem(itemId, 1);
            closeAllModals();
            
            typeText(feedbackText, false, () => {
                renderOptions(GAME_CONTENT[gameState.location].options);
            });
        }

        // --- EFECTOS DE JUEGO ---
        
        const gameEffects = {
            playScare: ({ text, shake }) => {
                displayTextEffect(`!!! ${text} !!!`, 'scare');
                if (shake) {
                    appContainer.classList.add('shake');
                    setTimeout(() => appContainer.classList.remove('shake'), 300);
                }
                updatePlayerStat('ansiedad', 25); // Aumenta la ansiedad
            },
            playSfx: (text) => {
                displayTextEffect(text, 'sfx');
            },
            playStatic: (text) => {
                displayTextEffect(`--- ${text} ---`, 'static');
            }
        };

        function displayTextEffect(text, type) {
            const el = document.createElement('div');
            el.textContent = text;
            
            if (type === 'static') el.className = 'static-line';
            else if (type === 'sfx') el.className = 'sfx-text';
            else if (type === 'scare') el.className = 'scare-text';
            
            narrativeLog.appendChild(el);
            narrativeLog.scrollTop = narrativeLog.scrollHeight;
        }

        // --- L칍GICA DEL MONSTRUO Y REACCI칍N ---
        
        function checkRuloAlert() {
            if (!gameState.flags.rulo_joins || gameState.ruloAlertCooldown > 0 || gameState.monsterPresent || gameState.monsterApproaching) {
                return;
            }
            
            const currentRoomNoise = gameState.roomNoise[gameState.location] || 0;
            const probDetect = RULO_ALERT_BASE_PROB + (RULO_ALERT_SKILL_FACTOR * gameState.ruloAlertSkill);
            if (Math.random() < probDetect && currentRoomNoise > 30) {
                gameState.ruloAlertActive = true;
                gameState.ruloAlertCooldown = RULO_ALERT_COOLDOWN;
                changeRoomNoise(gameState.location, -8);
                displayTextEffect('RULO: 럑메LGO NO VA BIEN, C츼LLATE!', 'sfx');
            }
        }

        function checkMonsterSpawn() {
            if (gameState.monsterPresent || gameState.monsterApproaching) return;

            const currentRoomNoise = gameState.roomNoise[gameState.location] || 0;
            let baseProb = 0.005; // 0.5%
            let noiseProb = (currentRoomNoise / 100) * 0.05; // 5% max
            
            let stateMultiplier = 1.0;
            if (currentRoomNoise > 40) { 
                if (gameState.playerStats.ansiedad >= 70) stateMultiplier = 3.0;
                else if (gameState.playerStats.vida <= 40) stateMultiplier = 2.5;
                else if (gameState.playerStats.hambre >= 80) stateMultiplier *= 1.2;
            }

            if (gameState.ruloAlertActive) {
                stateMultiplier *= 0.6;
                gameState.ruloAlertActive = false;
            }
            
            const finalProb = baseProb + (noiseProb * stateMultiplier);
            
            if (Math.random() < finalProb) {
                initiateMonsterApproach();
            }
        }

        function initiateMonsterApproach() {
            gameState.monsterApproaching = true;
            stopGameLoop(); 
            
            if (isTyping) {
                finishTyping(true);
            }
            optionsContainer.innerHTML = '';
            
            gameEffects.playSfx("...una sombra se alarga bajo la puerta...");
            
            const delay = 1000 + (Math.random() * 1000); // 1-2s
            setTimeout(spawnMonster, delay);
        }

        function spawnMonster() {
            gameState.monsterPresent = true;
            gameState.monsterApproaching = false;
            
            // Penalizaci칩n por estado
            let statePenalty = 0;
            if (gameState.playerStats.ansiedad >= 70) statePenalty += 0.2;
            if (gameState.playerStats.vida <= 40) statePenalty += 0.15;
            if (gameState.playerStats.hambre >= 80) statePenalty += 0.1;
            
            // Bonus de Rulo
            let ruloBonus = 1.0;
            if (gameState.flags.rulo_joins && gameState.ruloHP > 50) {
                ruloBonus = 1.15; // 15% m치s grande y m치s tiempo
            }
            
            const currentRoomNoise = gameState.roomNoise[gameState.location] || 0;

            // F칍RMULA DE TAMA칌O
            const sizeFactor = Math.max(0.4, Math.min(1.8, 0.6 + (currentRoomNoise / 200) - statePenalty)) * ruloBonus;
            const baseSize = 80; // px
            const size = Math.round(baseSize * sizeFactor);
            
            // F칍RMULA DE TIEMPO
            const normalizedFactor = (sizeFactor - 0.4) / (1.8 - 0.4); // 0 a 1
            reactionWindowMs = (1000 + (normalizedFactor * 2000)) * ruloBonus; // 1 a 3 segundos
            
            const narrativeRect = narrativeContainer.getBoundingClientRect();
            const rectWidth = narrativeRect.width || narrativeContainer.clientWidth;
            const rectHeight = narrativeRect.height || narrativeContainer.clientHeight;
            
            const btnX = Math.random() * (rectWidth - size - 40) + 20;
            const btnY = Math.random() * (rectHeight - size - 40) + 20;
            
            reactionBtn.style.width = `${size}px`;
            reactionBtn.style.height = `${size}px`;
            reactionBtn.style.top = `${btnY}px`;
            reactionBtn.style.left = `${btnX}px`;
            reactionBtn.textContent = (reactionWindowMs / 1000).toFixed(1);
            reactionBtn.style.display = 'flex';
            
            reactionStartTime = Date.now();
            
            reactionTimeout = setTimeout(failReaction, reactionWindowMs);
            reactionTimerInterval = setInterval(updateReactionTimer, 100);
        }
        
        function updateReactionTimer() {
            const elapsed = Date.now() - reactionStartTime;
            const remaining = Math.max(0, reactionWindowMs - elapsed);
            reactionBtn.textContent = (remaining / 1000).toFixed(1);
            
            // Penalizaci칩n por tiempo (reducci칩n de tama침o)
            const timePenalty = (elapsed / 10000);
            let statePenalty = 0;
            if (gameState.playerStats.ansiedad >= 70) statePenalty += 0.2;
            if (gameState.playerStats.vida <= 40) statePenalty += 0.15;
            
            let ruloBonus = 1.0;
            if (gameState.flags.rulo_joins && gameState.ruloHP > 50) {
                ruloBonus = 1.15;
            }
            
            const currentRoomNoise = gameState.roomNoise[gameState.location] || 0;
            const sizeFactor = Math.max(0.4, Math.min(1.8, 0.6 + (currentRoomNoise / 200) - statePenalty - timePenalty)) * ruloBonus;
            const baseSize = 80; // px
            const size = Math.round(baseSize * sizeFactor);
            reactionBtn.style.width = `${size}px`;
            reactionBtn.style.height = `${size}px`;
        }
        
        function clickReactionBtn() {
            clearTimeout(reactionTimeout);
            clearInterval(reactionTimerInterval);
            reactionBtn.style.display = 'none';
            
            gameState.monsterPresent = false;
            gameState.monsterTime = 0;
            changeRoomNoise(gameState.location, -15);
            updatePlayerStat('ansiedad', -30); // Recompensa
            
            typeText("...un movimiento r치pido. El Eco retrocede hacia las sombras. Est치s a salvo, por ahora.", false, () => {
                resumeGame();
            });
        }
        
        function failReaction() {
            clearInterval(reactionTimerInterval);
            reactionBtn.style.display = 'none';
            
            gameState.monsterPresent = false;
            gameState.monsterTime = 0;
            updatePlayerStat('vida', -25); // Penalizaci칩n de vida
            updatePlayerStat('ansiedad', 20); // Penalizaci칩n de ansiedad
            
            const items = Object.keys(gameState.inventory);
            let lostItem = "";
            if (items.length > 0) {
                const itemsToLose = items.filter(id => id !== 'mochila');
                if (itemsToLose.length > 0) {
                    const itemToLoseId = itemsToLose[Math.floor(Math.random() * itemsToLose.length)];
                    lostItem = gameState.inventory[itemToLoseId].name;
                    removeItem(itemToLoseId);
                }
            }
            
            typeText(`춰DEMASIADO TARDE!\nSientes un fr칤o desgarrador. El Eco te roza.\nPierdes tu [${lostItem || 'cordura'}] y te sientes herido.`, false, () => {
                resumeGame();
            });
        }


        // --- ACCIONES Y CONDICIONES DEL JUEGO ---
        
        function checkHasItem(id) { return hasItem(id); }
        function checkFlagFalse(flag) { return !gameState.flags[flag]; }
        function checkFlagTrue(flag) { return gameState.flags[flag]; }
        
        function rollD100() { return Math.floor(Math.random() * 100) + 1; }
        function hasItem(id) { return gameState.inventory[id] && gameState.inventory[id].qty > 0; }
        
        function addItem(id, name, rarity, qty = 1, consumable = false) {
            if (gameState.inventory[id]) {
                gameState.inventory[id].qty += qty;
            } else {
                gameState.inventory[id] = { id, name, rarity, qty, consumable };
            }
        }
        
        function removeItem(id, qty = 1) {
             if (hasItem(id)) {
                gameState.inventory[id].qty -= qty;
                if (gameState.inventory[id].qty <= 0) {
                    delete gameState.inventory[id];
                }
             }
        }

        /**
         * Modifica el ruido de una sala espec칤fica.
         * @param {string} roomId - El ID de la sala
         * @param {number} amount - Cantidad a sumar (puede ser negativo)
         * @param {boolean} [isDecay=false] - Si es true, no sube la ansiedad
         */
        function changeRoomNoise(roomId, amount, isDecay = false) {
            if (!roomId) roomId = gameState.location;
            
            let currentNoise = gameState.roomNoise[roomId] || 0;
            let newNoise = Math.max(0, Math.min(100, currentNoise + amount));
            gameState.roomNoise[roomId] = newNoise;
            
            // Aumentar ansiedad si el ruido sube (y no es decaimiento)
            if (amount > 0 && !isDecay) {
                updatePlayerStat('ansiedad', amount / 5);
            }
            
            // Actualizaci칩n instant치nea si es la sala actual
            if (roomId === gameState.location) {
                renderNoiseBar();
            }
        }
        
        function returnToPreviousLocation() {
            showNode(gameState.previousLocation || 'sala_vigilancia');
        }

        // --- Acciones de Nodos ---
        
        function enableBackpack() {
            addItem('mochila', 'Mochila', 'C', 1, false);
            gameState.flags.backpack_enabled = true;
            renderHeaderUI();
        }
        
        function despertarRulo(type) {
            gameState.flags.rulo_awake = true;
            let text = "";
            if (type === 'calm') {
                gameState.flags.rulo_awake_calm = true;
                text = "Lo sacudes suavemente. Rulo se sobresalta...\n'쯈u칠... d칩nde...?'\nSusurra, 'No... no recuerdo c칩mo llegamos. Solo... la est치tica.'";
                updateRuloHP(0); // No cambia la vida
            } else {
                // Brusco
                gameState.flags.rulo_awake_calm = false;
                text = "Lo sacudes con fuerza. Rulo se despierta con un grito ahogado.\n'춰NO! 춰NO ME TOQUES!'\nSe tapa la boca, pero el ruido ya est치 hecho.";
                changeRoomNoise(null, 30);
                gameEffects.playSfx("*GRITO AHOGADO*");
                updateRuloHP(-5); // Le asusta y "da침a"
            }
            typeText(text, true, () => renderOptions(GAME_CONTENT.sala_vigilancia.options));
        }
        
        function sintonizarRadio() {
            const roll = rollD100();
            let text = "Giras el dial. La est치tica es ensordecedora.\n";
            
            if (roll > 95) {
                text += "Voz clara: '...no conf칤es...'. Un compartimento se abre. [Fragmento de Cinta Magn칠tica].";
                addItem('cinta_magnetica', 'Cinta Magn칠tica', 'R');
                gameState.flags.radio_pista = true;
            } else if (roll > 60) {
                text += "Distingues un patr칩n: tres tonos... pausa... uno... pausa... dos. (3-1-2)";
                gameState.flags.radio_pista = true;
            } else {
                text += "춰CLACK! La radio suelta un chispazo y sube el volumen al m치ximo antes de morir.";
                changeRoomNoise(null, 30);
                gameEffects.playScare("EST츼TICA ENSORDECEDORA", true);
            }
            
            typeText(text, true, () => renderOptions(GAME_CONTENT.revisar_radio.options));
        }

        function forzarRadio() {
            const roll = rollD100();
            let text = "Usas el destornillador para forzar la carcasa...\n";
            
            if (roll <= 5) {
                text += "춰ERROR! El destornillador toca un capacitor. La radio explota. La puerta del S칩tano retumba.";
                changeRoomNoise(null, 100);
                gameEffects.playScare("EXPLOSI칍N DE RADIO", true);
                setTimeout(() => showNode('eco_cerca'), 1000);
                return;
            } else if (roll > 50) {
                text += "La carcasa cede. Dentro, encuentras una [Bater칤a Vieja].";
                addItem('bateria', 'Bater칤a Vieja', 'C', 1, true);
            } else {
                text += "Logras abrirla, pero no parece haber nada 칰til dentro.";
            }
            
            typeText(text, true, () => renderOptions(GAME_CONTENT.revisar_radio.options));
        }

        function buscarEnSala(roomId) {
            const roll = rollD100();
            let text = "Buscas entre las cajas y el equipo roto...\n";
            changeRoomNoise(roomId, 5);
            updatePlayerStat('hambre', 2);
            updatePlayerStat('agua', 3);
            
            if (roomId === 'sala_vigilancia') {
                if (roll > 80 && !hasItem('llave_oxidada')) {
                    text += "Debajo de unos papeles quemados, brilla una [Llave Oxidada].";
                    addItem('llave_oxidada', 'Llave Oxidada', 'R');
                } else if (roll > 60 && !hasItem('vendaje')) {
                    text += "En un botiqu칤n de pared, encuentras un [Vendaje].";
                    addItem('vendaje', 'Vendaje', 'C', 1, true);
                } else if (roll > 40 && !hasItem('destornillador')) {
                    text += "Encuentras un [Destornillador] en buen estado.";
                    addItem('destornillador', 'Destornillador', 'C');
                } else if (roll > 20 && !hasItem('nota_rasgada')) {
                    text += "Encuentras una [Nota Rasgada]: '...se alimenta del ruido.'";
                    addItem('nota_rasgada', 'Nota Rasgada', 'R');
                } else {
                    text += "Polvo, 칩xido y cables. Nada 칰til.";
                }
            }
            
            typeText(text, true, () => renderOptions(GAME_CONTENT[roomId].options));
        }
        
        function usarDestornilladorPanel() {
            const roll = rollD100();
            let text = "Metes el destornillador en el panel, intentando hacer palanca...\n";
            
            if (roll > 40) {
                text += "춰CLACK! Un rel칠 se activa. Las luces parpadean en verde. La puerta al Pasillo Este se abre.";
                changeRoomNoise(null, 15);
                gameState.flags.panel_abierto = true;
                if (!gameState.unlockedLocations.includes('pasillo_este_hub')) {
                    gameState.unlockedLocations.push('pasillo_este_hub');
                }
                renderLocations();
                setTimeout(() => showNode('parte1_fin_exito'), 1000);
            } else {
                text += "춰CHISPAZO! El destornillador resbala. Cortocircuito. La sala se oscurece un segundo.";
                changeRoomNoise(null, 40);
                gameEffects.playScare("CORTOCIRCUITO", true);
                typeText(text, true, () => renderOptions(GAME_CONTENT.panel_pasillo.options));
            }
        }
        
        function usarLlavePanel() {
            let text = "Pruebas la llave oxidada en la cerradura manual...\n";
            text += "Gira con un chirrido met치lico. La puerta al Pasillo Este se desbloquea y se abre.";
            changeRoomNoise(null, 20);
            gameEffects.playSfx("*CHIRRIDO MET츼LICO*");
            gameState.flags.panel_abierto = true;
            if (!gameState.unlockedLocations.includes('pasillo_este_hub')) {
                gameState.unlockedLocations.push('pasillo_este_hub');
            }
            renderLocations();
            setTimeout(() => showNode('parte1_fin_exito'), 1000);
        }
        
        function forzarPalancaPanel() {
             const roll = rollD100();
             let text = "Agarras la palanca de emergencia y tiras con todas tus fuerzas...\n";
             
             if (roll <= 20) {
                 text += "춰CRACK! La palanca se rompe. Un ruido met치lico retumba por el complejo.";
                 changeRoomNoise(null, 80);
                 gameEffects.playScare("RUIDO ESTRUENDOSO", true);
                 setTimeout(() => showNode('eco_cerca'), 1000);
             } else {
                 text += "Tiras y tiras, pero est치 atascada. No se mueve.";
                 changeRoomNoise(null, 10);
                 typeText(text, true, () => renderOptions(GAME_CONTENT.panel_pasillo.options));
             }
        }
        
        function hablarConRulo() {
            gameState.flags.rulo_talked = true;
            let text = "Te acercas a Rulo. Sigue temblando.\n'쯈u칠 quieres?', susurra.\n'쯌as a venir conmigo?'\n";
            
            let probAcompa침ar = 0.3;
            if (gameState.flags.rulo_awake_calm) probAcompa침ar = 0.6;
            if (gameState.ruloHP < 80) probAcompa침ar = 0.1;
            
            if (Math.random() < probAcompa침ar) {
                text += "Rulo asiente lentamente. 'No... no puedo quedarme aqu칤 solo. Ir칠 contigo. Pero debemos tener cuidado.'\nRulo ahora te acompa침a.";
                gameState.flags.rulo_joins = true;
            } else {
                text += "Rulo niega con la cabeza. 'No. Es demasiado peligroso. La voz... nos encontrar치. Me quedo aqu칤.'";
                gameState.flags.rulo_joins = false;
            }
            
            renderRuloState();
            typeText(text, true, () => renderOptions(GAME_CONTENT.pasillo_este_hub.options));
        }
        
        function explorarPasillo() {
            const roll = rollD100();
            let text = "Revisas las cajas de cart칩n mojadas, haciendo algo de ruido...\n";
            changeRoomNoise(null, 12);
            updatePlayerStat('hambre', 3);
            updatePlayerStat('agua', 4);
            
            if (roll > 75) {
                text += "춰Genial! Encuentras [Bater칤as] nuevas.";
                addItem('bateria', 'Bater칤a Vieja', 'C', 2, true);
            } else if (roll > 40) {
                text += "Dentro hay una [Barrita Energ칠tica] rancia.";
                addItem('barrita', 'Barrita Energ칠tica', 'C', 1, true);
            } else if (roll > 20) {
                text += "Encuentras una [Botella de Agua] medio llena.";
                addItem('botella_agua', 'Botella de Agua', 'C', 1, true);
            } else {
                text += "Vac칤a. Solo poliestireno h칰medo.";
            }
            
            const count = gameState.roomCounters['pasillo_este_hub'] || 0;
            const max = SEARCH_LIMITS['pasillo_este_hub'] || 0;
            text += `\n(Has revisado ${count}/${max} zonas)`;
            
            typeText(text, true, () => renderOptions(GAME_CONTENT.pasillo_este_hub.options));
        }
        
        function moverSigilo() {
            let text = "Avanzas despacio, pegado a la pared. Casi imperceptible.\n";
            changeRoomNoise(null, 2);
            
            if (Math.random() < 0.1) {
                text += "Algo brilla en una esquina. Es una [Llave Peque침a].";
                addItem('llave_oficina', 'Llave Peque침a', 'R');
            }
            
            text += "\nLlegas al final del pasillo. Hay dos puertas: 'Almac칠n' y 'Oficina de Seguridad'.";
            
            if (!gameState.unlockedLocations.includes('almacen')) {
                gameState.unlockedLocations.push('almacen');
            }
            if (!gameState.unlockedLocations.includes('oficina_seguridad')) {
                gameState.unlockedLocations.push('oficina_seguridad');
            }
            renderLocations();
            
            typeText(text, true, () => renderOptions(GAME_CONTENT.pasillo_este_hub.options));
        }
        
        function moverRapido() {
            let text = "Corres por el pasillo. Tus pisadas retumban.\n";
            changeRoomNoise(null, 35);
            updatePlayerStat('ansiedad', 10);
            updatePlayerStat('agua', 5);
            
            const roll = rollD100();
            
            if (roll < 30) {
                text += "춰Tropiezas con un tubo de metal! El estruendo es terrible.";
                changeRoomNoise(null, 25);
                gameEffects.playScare("ESTRUENDO MET츼LICO", true);
            } else {
                text += "Llegas al final. Ves las puertas del 'Almac칠n' y la 'Oficina de Seguridad'.";
                if (!gameState.unlockedLocations.includes('almacen')) {
                    gameState.unlockedLocations.push('almacen');
                }
                if (!gameState.unlockedLocations.includes('oficina_seguridad')) {
                    gameState.unlockedLocations.push('oficina_seguridad');
                }
                renderLocations();
            }
            
            typeText(text, true, () => renderOptions(GAME_CONTENT.pasillo_este_hub.options));
        }
        
        // --- NUEVO: Acciones del Puzzle de Ruido ---
        
        function solveNoisePuzzle(success) {
            const prevLoc = gameState.previousLocation;
            
            if (success) {
                gameState.roomNoise[prevLoc] = 0; // Resetea el ruido de la sala anterior
                typeText("춰칄xito! Un clic satisfactorio. El zumbido de fondo en la sala disminuye.\nEl ruido en esa zona ha sido purgado.", true, () => {
                    setTimeout(() => showNode(prevLoc), 1000);
                });
            } else {
                changeRoomNoise(prevLoc, 20); // Penalizaci칩n de ruido en la sala anterior
                gameEffects.playScare("FALLO DE SECUENCIA", true);
                typeText("춰Fallo! Un chispazo ensordecedor salta del panel. El ruido ha aumentado.", true, () => {
                    setTimeout(() => showNode(prevLoc), 1000);
                });
            }
        }


        // --- CONTENIDO DEL JUEGO (NODOS DE HISTORIA) ---

        const GAME_CONTENT = {
            'start': {
                // Este nodo ahora es solo un punto de entrada l칩gico
                isCheckpoint: true,
                text: "Cargando...",
                options: []
            },
            // --- NUEVO NODO DE INICIO ---
            'ajustes_dispositivo': {
                text: "Iniciando sistema...\nPor favor, selecciona tu modo de visualizaci칩n preferido.",
                options: [
                    // Estos ya no se usan, ya que la l칩gica est치 directamente en el event listener
                ]
            },
            'sala_vigilancia': {
                isLocationHub: true,
                isCheckpoint: true,
                text: "Te despiertas. La sala huele a polvo e incienso quemado. El monitor emite un zumbido bajo. En la esquina, una vieja radio en el canal 19.\n\nA tu lado est치 Rulo, dormido. En la pantalla parpadea: NO CONF칈E EN LAS VOCES.",
                options: [
                    { text: "Revisar la radio", target: "revisar_radio" },
                    { text: "Levantarte y buscar salida", target: "buscar_salida" },
                    { 
                        text: "Buscar algo 칰til en la sala", 
                        action: { func: "buscarEnSala", params: "sala_vigilancia" }, 
                        countsSearch: "sala_vigilancia"
                    },
                    { text: "Despertar a Rulo (Suavemente)", action: { func: "despertarRulo", params: "calm" }, condition: { func: "checkFlagFalse", params: "rulo_awake" } },
                    { text: "Despertar a Rulo (Bruscamente)", action: { func: "despertarRulo", params: "brusco" }, condition: { func: "checkFlagFalse", params: "rulo_awake" } },
                ]
            },
            'revisar_radio': {
                text: "La radio emite est치tica. La luz del canal 19 parpadea.",
                options: [
                    { text: "Intentar sintonizar manualmente", action: { func: "sintonizarRadio" }, condition: { func: "checkFlagFalse", params: "radio_pista" } },
                    { text: "Forzar radio con destornillador", action: { func: "forzarRadio" }, condition: { func: "checkHasItem", params: "destornillador" } },
                    { text: "Volver", target: "sala_vigilancia" }
                ]
            },
            'buscar_salida': {
                text: "La 칰nica salida parece ser una puerta met치lica pesada: 'PASILLO ESTE'. Est치 cerrada. Al lado hay un panel de control.",
                options: [
                    { text: "Inspeccionar panel de control", target: "panel_pasillo" },
                    { text: "Volver", target: "sala_vigilancia" }
                ]
            },
            'panel_pasillo': {
                text: "Un panel de acceso. La luz est치 en rojo. Necesita energ칤a o una llave para anular el cierre.",
                options: [
                    { text: "Usar Destornillador en el panel", action: { func: "usarDestornilladorPanel" }, condition: { func: "checkHasItem", params: "destornillador" } },
                    { text: "Usar Llave Oxidada", action: { func: "usarLlavePanel" }, condition: { func: "checkHasItem", params: "llave_oxidada" } },
                    { text: "Forzar palanca de emergencia", action: { func: "forzarPalancaPanel" } },
                    { text: "Volver", target: "sala_vigilancia" }
                ]
            },
            
            'parte1_fin_exito': {
                text: "La puerta al pasillo chisporrotea y se abre.\nUn golpe seco viene del s칩tano. Una sombra pasa por la rendija de la puerta del s칩tano, fugazmente.",
                effect: { name: "playScare", params: { text: "SOMBRA EN EL S칍TANO", shake: true } },
                options: [
                    { text: "[Entrar al Pasillo Este]", target: "pasillo_este_intro" },
                ]
            },
            'eco_cerca': {
                text: "El estruendo resuena. La radio grita: NO  C O N F 칈 E .\nDe pronto, la voz susurra TU NOMBRE.\nEl Eco est치 cerca.",
                effect: { name: "playStatic", params: "EL ECO EST츼 CERCA" },
                options: [
                    { text: "[FIN DE LA DEMO - REINICIAR]", target: "start" }
                ]
            },
            
            // --- PARTE 2 ---
            'pasillo_este_intro': {
                isCheckpoint: true,
                text: "Abres la puerta al pasillo Este. La luz de emergencia titila en rojo. A la derecha, apoyada contra una columna, hay una mochila vieja.",
                options: [
                    { text: "Abrir la mochila", target: "abrir_mochila" }
                ]
            },
            'abrir_mochila': {
                text: "Abres la mochila. Est치 vac칤a, pero limpia. Transfieres tus cosas a ella.\n(Has conseguido la [Mochila]. Puedes abrirla con [M]).",
                onEnter: { func: "enableBackpack" },
                options: [
                    { text: "Continuar por el pasillo", target: "pasillo_este_hub" }
                ]
            },
            'pasillo_este_hub': {
                isLocationHub: true,
                text: "Est치s en el Pasillo Este. Hay cajas de suministros podridas. Al fondo, el pasillo se bifurca. El zumbido es m치s fuerte aqu칤.",
                options: [
                    { 
                        text: "Revisar cajas (Ruta Exploratoria)", 
                        action: { func: "explorarPasillo" },
                        countsSearch: "pasillo_este_hub"
                    },
                    { 
                        text: "Avanzar con cuidado (Ruta Cautelosa)", 
                        action: { func: "moverSigilo" } 
                    },
                    { 
                        text: "Correr al fondo (Ruta R치pida)", 
                        action: { func: "moverRapido" } 
                    },
                    { 
                        text: "Hablar con Rulo", 
                        action: { func: "hablarConRulo" }, 
                        condition: { func: "checkFlagTrue", params: "rulo_awake" },
                        condition: { func: "checkFlagFalse", params: "rulo_talked" } 
                    },
                    { text: "Volver a la Sala de Vigilancia", target: "sala_vigilancia" }
                ]
            },
            
            'almacen': {
                isLocationHub: true,
                text: "Llegas al almac칠n. Cajas apiladas, olor a aceite. Se oyen rascaduras detr치s de una estanter칤a.",
                options: [
                    { text: "Buscar suministros (Pr칩ximamente)", target: "almacen" },
                    { text: "Mover caja grande (Pr칩ximamente)", target: "almacen" },
                    { text: "Volver al Pasillo Este", target: "pasillo_este_hub" }
                ]
            },
            'oficina_seguridad': {
                isLocationHub: true,
                text: "Entras a la oficina de seguridad. Un escritorio volcado, notas en el suelo. Hay una llave colgando de un tablero.",
                options: [
                    { text: "Leer notas (Pr칩ximamente)", target: "oficina_seguridad" },
                    { text: "Coger llave (Pr칩ximamente)", target: "oficina_seguridad" },
                    { text: "Volver al Pasillo Este", target: "pasillo_este_hub" }
                ]
            },
            'sotano': {
                isLocationHub: true,
                text: "La puerta al s칩tano est치 cerrada con cadenas.",
                options: [
                     { text: "Volver a la Sala de Vigilancia", target: "sala_vigilancia" }
                ]
            },
            
            // --- NUEVO: Nodos de Puzzle de Ruido ---
            'puzzle_ruido_intro': {
                text: "Te concentras en el panel de la barra de ruido. Puedes intentar recalibrarlo.\nMientras manipulas el panel, el riesgo de aparici칩n aumenta ligeramente.",
                options: [
                    { text: "Ordenar fusibles (F치cil)", target: "puzzle_fusibles_1" },
                    { text: "Cancelar", action: { func: "returnToPreviousLocation" } }
                ]
            },
            'puzzle_fusibles_1': {
                text: "Hay 3 ranuras: [1] [2] [3]. Y 3 fusibles: [Rojo] [Verde] [Azul].\nUna nota dice: 'El verde estabiliza. El rojo potencia. El azul enfr칤a.'\nDebes poner el estabilizador *antes* que el de potencia.",
                options: [
                    { text: "Insertar: Azul, Verde, Rojo", action: { func: "solveNoisePuzzle", params: false } },
                    { text: "Insertar: Verde, Azul, Rojo", action: { func: "solveNoisePuzzle", params: true } }, // Correcto
                    { text: "Insertar: Rojo, Verde, Azul", action: { func: "solveNoisePuzzle", params: false } }
                ]
            }
        };

        // --- INICIALIZACI칍N Y EVENT LISTENERS ---
        
        function init() {
            // Navegaci칩n Men칰
            $('#play-btn').addEventListener('click', () => startGameFromMenu(false)); // MODIFICADO
            $('#load-checkpoint-btn').addEventListener('click', loadCheckpoint);
            $('#settings-btn').addEventListener('click', () => showScreen('settings'));
            $('#back-to-menu-btn').addEventListener('click', goToMenu);
            $('#game-back-to-menu-btn').addEventListener('click', goToMenu);
            $('#change-device-btn').addEventListener('click', () => showScreen('device_select')); // NUEVO
            
            // Opciones de Tema
            $('#theme-select').addEventListener('change', (e) => {
                changeTheme(e.target.value);
            });
            // Restaurar tema guardado
            const savedTheme = localStorage.getItem('transmision_theme') || 'green';
            $('#theme-select').value = savedTheme;
            changeTheme(savedTheme);
            
            // UI del Juego
            $('#backpack-btn').addEventListener('click', toggleBackpack);
            $('#close-backpack-btn').addEventListener('click', closeAllModals);
            $('#reaction-btn').addEventListener('click', clickReactionBtn);
            
            // Listeners de Modales de Stats
            $('#player-state-button').addEventListener('click', togglePlayerStats);
            $('#close-player-stats-btn').addEventListener('click', closeAllModals);
            $('#rulo-hud').addEventListener('click', toggleRuloStats);
            $('#close-rulo-stats-btn').addEventListener('click', closeAllModals);
            
            // Listener de Teclado
            window.addEventListener('keydown', (e) => {
                // --- 'M' and 'E' keys only work IN-GAME ---
                // MODIFICADO: Usar style.display para chequear
                if (gameScreen.style.display === 'flex') {
                    if (e.key.toLowerCase() === 'm' && gameState.flags.backpack_enabled) {
                        toggleBackpack();
                    }
                    // NUEVO: Atajo [E] para estado
                    if (e.key.toLowerCase() === 'e') {
                        togglePlayerStats();
                    }
                }

                // --- 'Escape' key works GLOBALLY ---
                if (e.key === 'Escape') {
                    // Prioridad 1: Cerrar modales si est치n abiertos
                    if (!backpackModal.classList.contains('hidden') || 
                        !playerStatsModal.classList.contains('hidden') || 
                        !ruloStatsModal.classList.contains('hidden')) {
                        closeAllModals();
                    }
                    // Prioridad 2: Salir de Ajustes al Men칰 Principal
                    else if (settingsScreen.style.display === 'flex') {
                        showScreen('main');
                    }
                    // Prioridad 3: Salir del Juego al Men칰 Principal (Pausar)
                    else if (gameScreen.style.display === 'flex') {
                        goToMenu();
                    }
                    // No hacer nada en el men칰 principal o en la selecci칩n de dispositivo
                }
            });
            
            // Click en la barra de ruido
            $('#noise-bar-container').addEventListener('click', () => {
                if (isTyping || gameScreen.style.display === 'none' || gameState.monsterPresent || gameState.monsterApproaching) return;
                // Iniciar el puzzle
                showNode('puzzle_ruido_intro');
            });

            // Comprobar estado de guardado al cargar
            if (localStorage.getItem(SAVE_KEY_CURRENT)) {
                $('#play-btn').textContent = 'Continuar';
            } else {
                $('#play-btn').textContent = 'Jugar';
            }
            if (!localStorage.getItem(SAVE_KEY_CHECKPOINT)) {
                $('#load-checkpoint-btn').classList.add('hidden');
            }
            
            // --- L칩gica de Inicio con Selector de Dispositivo ---
            $('#device-btn-mobile').addEventListener('click', () => selectDevice('mobile'));
            $('#device-btn-pc').addEventListener('click', () => selectDevice('pc'));
            
            const savedDevice = localStorage.getItem(SAVE_KEY_DEVICE);
            if (savedDevice) {
                // Si ya est치 guardado, se aplica el dispositivo y se muestra el men칰
                selectDevice(savedDevice); 
            } else {
                // Si es la primera vez, solo se muestra el selector.
                showScreen('device_select'); 
            }
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>