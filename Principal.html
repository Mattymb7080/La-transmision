<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Transmisi칩n Rota</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuente Inter (para men칰s) y IBM Plex Mono (para el juego) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Enlace al archivo CSS externo -->
    <link rel="stylesheet" href="Estilos.css">
</head>
<body class="device-pc"> <!-- Inicia como PC por defecto, JS lo cambiar치 -->

    <div id="app">
    
        <!-- Overlay de Selecci칩n de Dispositivo -->
        <div id="device-select-overlay" class="hidden">
            <div id="device-select-box">
                <h2 class="text-2xl font-bold mb-6">Selecciona tu dispositivo</h2>
                <div class="flex">
                    <button id="device-btn-mobile" class="btn device-btn">游님</button>
                    <button id="device-btn-pc" class="btn device-btn">游눹</button>
                </div>
            </div>
        </div>

        <!-- Pantalla: Men칰 Principal -->
        <div id="main-menu" class="hidden flex-col items-center justify-center h-full p-8">
            <!-- Contenedor para que el z-index funcione -->
            <div id="main-menu-content-wrapper" class="flex flex-col items-center justify-center h-full w-full">
                <h1 class="text-6xl font-bold font-mono text-center mb-12" style="color: var(--theme-text); text-shadow: var(--theme-glow);">LA TRANSMISI칍N</h1>
                
                <button id="play-btn" class="btn text-2xl mb-6 w-64">Jugar</button>
                <button id="settings-btn" class="btn text-xl w-64 mb-4">Ajustes</button>
                <button id="load-checkpoint-btn" class="btn btn-secondary text-lg w-64">Repetir desde guardado</button>
            </div>
        </div>

        <!-- Pantalla de Selecci칩n de Dificultad -->
        <div id="difficulty-select-screen" class="hidden flex-col items-center justify-center h-full p-8">
            <h2 class="text-3xl font-bold mb-8" style="color: var(--theme-text);">SELECCIONA DIFICULTAD</h2>
            
            <button id="difficulty-easy" class="btn btn-easy text-xl w-64 mb-4">F치cil</button>
            <button id="difficulty-medium" class="btn btn-medium text-xl w-64 mb-4">Medio</button>
            <button id="difficulty-hard" class="btn btn-hard text-xl w-64 mb-4">Dif칤cil</button>
            <button id="difficulty-nightmare" class="btn btn-nightmare text-xl w-64 mb-4">PESADILLA</button>
            
            <button id="difficulty-back-btn" class="btn text-xl w-64 mt-auto">Volver</button>
        </div>


        <!-- Pantalla: Opciones -->
        <div id="settings-screen" class="hidden flex-col items-center h-full p-8">
            <h2 class="text-3xl font-bold mb-8" style="color: var(--theme-text);">AJUSTES</h2>
            
            <select id="theme-select">
                <option value="green">Verde CRT</option>
                <option value="amber">츼mbar</option>
                <option value="blue">Azul</option>
                <option value="blanco">Blanco</option>
                <option value="negro">Negro</option>
            </select>
            
            <button id="change-device-btn" class="btn text-xl w-64 mt-6">Cambiar Dispositivo</button>
            
            <button id="reset-data-btn" class="btn btn-danger text-xl w-64 mt-6">Resetear Datos</button>
            
            <button id="back-to-menu-btn" class="btn text-xl w-64 mt-auto">Volver</button>
        </div>

        <!-- Pantalla: Juego -->
        <div id="game-screen" class="hidden h-full">
            
            <!-- Encabezado del juego -->
            <div id="game-header" class="flex justify-between items-center">
                <button id="game-back-to-menu-btn" class="btn text-sm py-2 px-4">MEN칔</button>
                <div class="flex items-center space-x-4">
                    <!-- Bot칩n de Mochila (re-implementado) -->
                    <button id="backpack-btn" class="btn text-sm py-2 px-4 hidden">MOCHILA [M]</button>
                    <div id="player-state-button" class="text-sm">
                        ESTADO: <span id="player-state" class="font-bold life-ok">CALMADO</span>
                    </div>
                    <!-- Medidor de Probabilidad de Monstruo -->
                    <div id="monster-prob-hud" class="hidden">
                        PROB: <span id="monster-prob-value" class="font-bold">0%</span>
                    </div>
                    <div id="rulo-hud" class="hidden">
                        RULO: <span id="rulo-state" class="font-bold life-ok">OK</span>
                    </div>
                </div>
            </div>

            <!-- Contenedor de la narrativa -->
            <div id="narrative-container" class="flex-grow flex flex-row relative" onclick="handleNarrativeClick()">
                
                <!-- Columna Izquierda (Principal) -->
                <div id="main-column" class="flex-grow flex flex-col">
                    <div id="narrative-log">
                        <!-- El texto del juego aparece aqu칤 -->
                    </div>
                    
                    <div id="options-container">
                        <!-- Las opciones [ ] aparecen aqu칤 -->
                    </div>
                </div>

                <!-- Columna Derecha (Notificaciones) -->
                <div id="notification-column" class_recreated="w-1/3 max-w-sm flex flex-col">
                    <!-- Contenedor de Probabilidad (solo visible si Rulo acompa침a) -->
                    <div id="rulo-prob-header" class="hidden p-2 text-center">
                        <!-- El JS llenar치 esto -->
                    </div>
                    <div id="notification-log" class="flex-grow p-2">
                        <!-- Notificaciones de monstruos y eventos aqu칤 -->
                    </div>
                </div>
            </div>

            <!-- Pie de p치gina (Ruido y Ubicaciones) -->
            <div id="game-footer" class="space-y-4">
                <div class="flex items-center space-x-3">
                    <span class="font-bold">RUIDO:</span>
                    <div id="noise-bar-container" class="flex-grow" title="Intentar reducir ruido...">
                        <div id="noise-bar"></div>
                    </div>
                    <span id="noise-value" class="font-bold w-12 text-right">0</span>
                    <span id="noise-text" class="w-20 text-left" style="color: var(--theme-calm);">Tranquilo</span>
                </div>
                <div class="flex items-center">
                    <span class="font-bold mr-4">UBICACI칍N:</span>
                    <div id="location-menu" class="inline-block">
                        <!-- Botones de ubicaci칩n aqu칤 -->
                    </div>
                    <!-- Bot칩n Hablar con Rulo -->
                    <button id="talk-rulo-btn" class="btn text-sm py-1 px-3 ml-4 hidden">[ Hablar con Rulo ]</button>
                </div>
            </div>
        </div>

        <!-- Modal de Mochila (Inventario) -->
        <div id="backpack-modal" class="modal hidden">
            <h2 class="modal-title">[ MOCHILA ]</h2>
            <div id="backpack-list" class="space-y-3 mb-6">
                <!-- Items del inventario aqu칤 -->
                <div class="backpack-item">Cargando...</div>
            </div>
            
            <!-- Secci칩n de Notas -->
            <h3 class="modal-title-medium">[ NOTAS Y DOCUMENTOS ]</h3>
            <div id="backpack-notes-list" class="space-y-2 mb-6">
                <!-- Las notas (items clicables) aparecer치n aqu칤 -->
                <div class="backpack-note-item">No has encontrado notas.</div>
            </div>
            
            <!-- NUEVO: Bot칩n Combinar -->
            <button id="combine-fragments-btn" class="btn btn-easy w-full mb-4 hidden">[ Combinar Fragmentos ]</button>
            
            <button id="close-backpack-btn" class="btn w-full">Cerrar mochila</button>
        </div>
        
        <!-- Modal Lector de Notas -->
        <div id="note-reader-modal" class="modal hidden">
            <h2 id="note-reader-title" class="modal-title">[ T칈TULO DE LA NOTA ]</h2>
            <div id="note-reader-content" class="note-content-box">
                <p>El contenido de la nota aparecer치 aqu칤...</p>
            </div>
            <button id="close-note-reader-btn" class="btn w-full mt-6">Cerrar nota</button>
        </div>

        <!-- Modal de Estad칤sticas del Jugador -->
        <div id="player-stats-modal" class="modal hidden">
            <h2 class="modal-title">[ ESTADO DEL JUGADOR ]</h2>
            <ul id="player-stats-list" class="stats-list">
                <!-- Stats se llenan din치micamente -->
            </ul>
            <button id="close-player-stats-btn" class="btn w-full">Cerrar</button>
        </div>
        
        <!-- Modal de Estad칤sticas de Rulo -->
        <div id="rulo-stats-modal" class="modal hidden">
            <h2 class="modal-title">[ ESTADO DE RULO ]</h2>
            <ul id="rulo-stats-list" class="stats-list">
                <!-- Stats se llenan din치micamente -->
            </ul>
            <button id="close-rulo-stats-btn" class="btn w-full">Cerrar</button>
        </div>
        
        <!-- Modal de Confirmaci칩n Gen칠rico -->
        <div id="confirm-modal" class="modal hidden">
            <h2 class="text-2xl font-bold mb-6">CONFIRMAR ACCI칍N</h2>
            <p id="confirm-message" class="mb-6">쮼st치s seguro?</p>
            <div class="flex justify-between">
                <button id="confirm-btn-yes" class="btn btn-danger w-5/12">S칈</button>
                <button id="confirm-btn-no" class="btn btn-medium w-5/12">NO</button>
            </div>
        </div>
        
        <!-- Minijuego de Calma (Ansiedad) -->
        <div id="calm-minigame" class="hidden">
            <h3 class="calm-minigame-title">MANT칄N LA CALMA</h3>
            <p class="mb-6">Presiona [ESPACIO] o TOCA en la zona verde</p>
            
            <div id="calm-tap-area" onclick="checkCalmHit()">
                <div id="calm-bar">
                    <div id="calm-target"></div>
                    <div id="calm-marker"></div>
                </div>
            </div>
            
            <button id="calm-cancel-btn" class="btn btn-secondary text-lg mt-6">Cancelar</button>
        </div>
        
        <!-- Modal de Selecci칩n de Minijuego de Ruido -->
        <div id="noise-minigame-select-modal" class="modal hidden">
            <h2 class="modal-title">[ CONTROL DE RUIDO ]</h2>
            
            <div id="noise-select-current-noise" class="text-center text-lg mb-6">
                Ruido actual: <span class="font-bold" style="color: var(--theme-agitated);">Cargando...</span>
            </div>
            
            <p class="mb-6 text-center" style="color: var(--theme-text-dim);">Elige una acci칩n para intentar reducir el ruido de la sala.</p>
            
            <div class="flex flex-col gap-4">
                <button id="noise-select-fuse-btn" class="btn btn-medium w-full">Ordenar Fusibles (R치pido)</button>
                <button id="noise-select-resonance-btn" class="btn btn-medium w-full">Cadena de Resonancia (Dif칤cil)</button>
                <button id="noise-select-cancel-btn" class="btn btn-secondary w-full mt-4">Cancelar</button>
            </div>
        </div>
        
        <!-- Minijuego de Fusibles -->
        <div id="fuse-minigame-modal" class="modal hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">[ RECALIBRANDO FUSIBLES ]</h2>
                <span id="fuse-timer" class="text-3xl font-bold" style="color: var(--theme-scare);">0.0</span>
            </div>
            
            <div id="fuse-hint-box" class="hint-box mb-4">
                PISTA: Cargando...
            </div>
            
            <div id="fuse-options-container" class="flex flex-wrap gap-2 mb-4">
                <!-- Botones de fusibles (ej: Azul, Rojo) se a침adir치n aqu칤 por JS -->
            </div>
            
            <div id="fuse-sequence-display" class="sequence-box mb-6">
                ...
            </div>
            
            <div class="flex justify-between gap-4">
                <button id="fuse-confirm-btn" class="btn btn-easy w-1/2">CONFIRMAR</button>
                <button id="fuse-clear-btn" class="btn btn-secondary w-1/2">LIMPIAR</button>
            </div>
            
            <!-- Bot칩n de cancelar -->
            <button id="fuse-cancel-btn" class="btn btn-secondary w-full mt-4">Cancelar</button>
        </div>
        
        <!-- Minijuego Cadena de Resonancia -->
        <div id="resonance-minigame-modal" class="modal modal-large hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">[ CADENA DE RESONANCIA ]</h2>
                <span id="resonance-timer" class="text-3xl font-bold" style="color: var(--theme-scare);">0.0</span>
            </div>
            
            <div id="resonance-hint-box" class="hint-box mb-4">
                SECUENCIA: Cargando...
            </div>
            
            <div id="resonance-canvas-container" class="w-full">
                <!-- El canvas se dibujar치 aqu칤. JS necesario. -->
                <canvas id="resonance-canvas" width="600" height="400"></canvas>
            </div>
            
            <button id="resonance-cancel-btn" class="btn btn-secondary w-full mt-6">Abortar recalibraci칩n</button>
        </div>
        
        <!-- Modal de Teclado de Caja Fuerte -->
        <div id="safe-keypad-modal" class="modal hidden">
            <h2 class="modal-title">[ CAJA FUERTE ]</h2>
            <p class="mb-6 text-center" style="color: var(--theme-text-dim);">Introduce la combinaci칩n de 4 d칤gitos.</p>
            
            <div id="safe-keypad-display" class="flex justify-center gap-4 mb-8">
                <div id="keypad-digit-0" class="keypad-digit" data-value="0">0</div>
                <div id="keypad-digit-1" class="keypad-digit" data-value="0">0</div>
                <div id="keypad-digit-2" class="keypad-digit" data-value="0">0</div>
                <div id="keypad-digit-3" class="keypad-digit" data-value="0">0</div>
            </div>
            
            <div class="flex justify-between gap-4">
                <button id="safe-keypad-confirm" class="btn btn-easy w-1/2">ABRIR</button>
                <button id="safe-keypad-cancel" class="btn btn-secondary w-1/2">CANCELAR</button>
            </div>
        </div>
        
        <!-- Pantalla de Transici칩n de Noche (HTML inicial debe estar oculto) -->
        <div id="night-transition-overlay" class="hidden">
            <div class="scanline-effect"></div>
            <div id="night-transition-text" class="night-text-glitch" data-text="NOCHE 1">NOCHE 1</div>
        </div>

        
        <!-- Icono de guardado -->
        <div id="save-icon">游</div>
        
        <!-- Bot칩n de Reacci칩n Din치mico -->
        <button id="reaction-btn">
            <!-- El temporizador puede ir aqu칤 -->
        </button>
        
        <!-- Overlay de Muerte -->
        <div id="death-overlay" class="hidden"></div>

    </div>

    <!-- 
      CAMBIO IMPORTANTE: 
      Ahora cargamos la l칩gica en dos partes.
      El orden es importante.
    -->
    <script src="Logica_Parte1.js"></script>
    <script src="Logica_Parte2.js"></script>
</body>
</html>
